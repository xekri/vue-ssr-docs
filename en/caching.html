
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Caching Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-vuejs/vue.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="streaming.html" />
    
    
    <link rel="prev" href="head.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="basic.html">
            
                <a href="basic.html">
            
                    
                    Basic Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="universal.html">
            
                <a href="universal.html">
            
                    
                    Writing Universal Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="structure.html">
            
                <a href="structure.html">
            
                    
                    Source Code Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="routing.html">
            
                <a href="routing.html">
            
                    
                    Routing and Code-Splitting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="data.html">
            
                <a href="data.html">
            
                    
                    Data Pre-fetching and State
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="hydration.html">
            
                <a href="hydration.html">
            
                    
                    Client Side Hydration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="bundle-renderer.html">
            
                <a href="bundle-renderer.html">
            
                    
                    Introducing Bundle Renderer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="build-config.html">
            
                <a href="build-config.html">
            
                    
                    Build Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="css.html">
            
                <a href="css.html">
            
                    
                    CSS Management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="head.html">
            
                <a href="head.html">
            
                    
                    Head Management
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.12" data-path="caching.html">
            
                <a href="caching.html">
            
                    
                    Caching
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="streaming.html">
            
                <a href="streaming.html">
            
                    
                    Streaming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="api.html">
            
                <a href="api.html">
            
                    
                    API Reference
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="api.html">
            
                <a href="api.html#createrendereroptions">
            
                    
                    createRenderer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2" data-path="api.html">
            
                <a href="api.html#createbundlerendererbundle-options">
            
                    
                    createBundleRenderer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.3" data-path="api.html">
            
                <a href="api.html#class-renderer">
            
                    
                    Class: Renderer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.4" data-path="api.html">
            
                <a href="api.html#class-bundlerenderer">
            
                    
                    Class: BundleRenderer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5" data-path="api.html">
            
                <a href="api.html#renderer-options">
            
                    
                    Renderer Options
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.5.1" data-path="api.html">
            
                <a href="api.html#template">
            
                    
                    template
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5.2" data-path="api.html">
            
                <a href="api.html#clientmanifest">
            
                    
                    clientManifest
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5.3" data-path="api.html">
            
                <a href="api.html#inject">
            
                    
                    inject
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5.4" data-path="api.html">
            
                <a href="api.html#shouldpreload">
            
                    
                    shouldPreload
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5.5" data-path="api.html">
            
                <a href="api.html#runinnewcontext">
            
                    
                    runInNewContext
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5.6" data-path="api.html">
            
                <a href="api.html#basedir">
            
                    
                    basedir
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5.7" data-path="api.html">
            
                <a href="api.html#cache">
            
                    
                    cache
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.5.8" data-path="api.html">
            
                <a href="api.html#directives">
            
                    
                    directives
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14.6" data-path="api.html">
            
                <a href="api.html#webpack-plugins">
            
                    
                    webpack Plugins
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Caching</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="caching">Caching</h1>
<p>Although Vue&apos;s SSR is quite fast, it can&apos;t match the performance of pure string-based templating due to the cost of creating component instances and Virtual DOM nodes. In cases where SSR performance is critical, wisely leveraging caching strategies can greatly improve response time and reduce server load.</p>
<h2 id="page-level-caching">Page-level Caching</h2>
<p>A server-rendered app in most cases relies on external data, so the content is dynamic by nature and cannot be cached for extended periods. However, if the content is not user-specific (i.e. for the same URL it always renders the same content for all users), we can leverage a strategy called <a href="https://www.nginx.com/blog/benefits-of-microcaching-nginx/" target="_blank">micro-caching</a> to drastically improve our app&apos;s capability of handling high traffic.</p>
<p>This is usually done at the Nginx layer, but we can also implement it in Node.js:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> microCache = LRU({
  max: <span class="hljs-number">100</span>,
  maxAge: <span class="hljs-number">1000</span> <span class="hljs-comment">// Important: entries expires after 1 second.</span>
})

<span class="hljs-keyword">const</span> isCacheable = req =&gt; {
  <span class="hljs-comment">// implement logic to check if the request is user-specific.</span>
  <span class="hljs-comment">// only non-user-specific pages are cache-able</span>
}

server.get(<span class="hljs-string">&apos;*&apos;</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> cacheable = isCacheable(req)
  <span class="hljs-keyword">if</span> (cacheable) {
    <span class="hljs-keyword">const</span> hit = microCache.get(req.url)
    <span class="hljs-keyword">if</span> (hit) {
      <span class="hljs-keyword">return</span> res.end(hit)
    }
  }

  renderer.renderToString((err, html) =&gt; {
    res.end(html)
    <span class="hljs-keyword">if</span> (cacheable) {
      microCache.set(req.url, html)
    }
  })
})
</code></pre>
<p>Since the content is cached for only one second, users will not see outdated content. However, this means the server only has to perform at most one full render per second for each cached page.</p>
<h2 id="component-level-caching">Component-level Caching</h2>
<p><code>vue-server-renderer</code> has built-in support for component-level caching. To enable it you need to provide a <a href="api.html#cache">cache implementation</a> when creating the renderer. Typical usage is passing in an <a href="https://github.com/isaacs/node-lru-cache" target="_blank">lru-cache</a>:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> LRU = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;lru-cache&apos;</span>)

<span class="hljs-keyword">const</span> renderer = createRenderer({
  cache: LRU({
    max: <span class="hljs-number">10000</span>,
    maxAge: ...
  })
})
</code></pre>
<p>You can then cache a component by implementing a <code>serverCacheKey</code> function:</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  name: <span class="hljs-string">&apos;item&apos;</span>, <span class="hljs-comment">// required</span>
  props: [<span class="hljs-string">&apos;item&apos;</span>],
  serverCacheKey: props =&gt; props.item.id,
  render (h) {
    <span class="hljs-keyword">return</span> h(<span class="hljs-string">&apos;div&apos;</span>, <span class="hljs-keyword">this</span>.item.id)
  }
}
</code></pre>
<p>Note that cache-able component <strong>must also define a unique <code>name</code> option</strong>. With a unique name, the cache key is thus per-component: you don&apos;t need to worry about two components returning the same key.</p>
<p>The key returned from <code>serverCacheKey</code> should contain sufficient information to represent the shape of the render result. The above is a good implementation if the render result is solely determined by <code>props.item.id</code>. However, if the item with the same id may change over time, or if render result also relies on another prop, then you need to modify your <code>getCacheKey</code> implementation to take those other variables into account.</p>
<p>Returning a constant will cause the component to always be cached, which is good for purely static components.</p>
<h3 id="when-to-use-component-caching">When to use component caching</h3>
<p>If the renderer hits a cache for a component during render, it will directly reuse the cached result for the entire sub tree. This means you should <strong>NOT</strong> cache a component when:</p>
<ul>
<li>It has child components that may rely on global state.</li>
<li>It has child components that produces side effects on the render <code>context</code>.</li>
</ul>
<p>Component caching should therefore be applied carefully to address performance bottlenecks. In most cases, you shouldn&apos;t and don&apos;t need to cache single-instance components. The most common type of components that are suitable for caching are ones repeated in big <code>v-for</code> lists. Since these components are usually driven by objects in database collections, they can make use of a simple caching strategy: generate their cache keys using their unique id plus the last updated timestamp:</p>
<pre><code class="lang-js">serverCacheKey: props =&gt; props.item.id + <span class="hljs-string">&apos;::&apos;</span> + props.item.last_updated
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="head.html" class="navigation navigation-prev " aria-label="Previous page: Head Management">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="streaming.html" class="navigation navigation-next " aria-label="Next page: Streaming">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Caching","level":"1.12","depth":1,"next":{"title":"Streaming","level":"1.13","depth":1,"path":"streaming.md","ref":"streaming.md","articles":[]},"previous":{"title":"Head Management","level":"1.11","depth":1,"path":"head.md","ref":"head.md","articles":[]},"dir":"ltr"},"config":{"plugins":["edit-link","theme-vuejs@git+https://github.com/pearofducks/gitbook-plugin-theme-vuejs.git","-fontsettings","github"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"edit-link":{"label":"Edit This Page","base":"https://github.com/vuejs/vue-ssr-docs/edit/master/"},"github":{"url":"https://github.com/vuejs/vue-ssr-docs/"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":false,"twitter":false,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-vuejs":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"language":"en","links":{"sharing":{"facebook":false,"twitter":false}},"gitbook":"*"},"file":{"path":"caching.md","mtime":"2017-08-24T05:24:43.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-08-24T05:42:05.628Z"},"basePath":".","book":{"language":"en"}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    

    </body>
</html>

